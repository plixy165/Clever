"use strict";(()=>{var e=self.Ultraviolet,t=["cross-origin-embedder-policy","cross-origin-opener-policy","cross-origin-resource-policy","content-security-policy","content-security-policy-report-only","expect-ct","feature-policy","origin-isolation","strict-transport-security","upgrade-insecure-requests","x-content-type-options","x-download-options","x-frame-options","x-permitted-cross-domain-policies","x-powered-by","x-xss-protection"],r=["GET","HEAD"],i=class extends e.EventEmitter{constructor(t=__uv$config){super(),t.prefix||(t.prefix="/service/"),this.config=t,this.bareClient=new e.BareClient}route({request:e}){return!!e.url.startsWith(location.origin+this.config.prefix)}async fetch({request:i}){let a;try{if(!i.url.startsWith(location.origin+this.config.prefix))return await fetch(i);let l=new e(this.config);"function"==typeof this.config.construct&&this.config.construct(l,"service");let c=await l.cookie.db();l.meta.origin=location.origin,l.meta.base=l.meta.url=new URL(l.sourceUrl(i.url));let d=new n(i,l,r.includes(i.method.toUpperCase())?null:await i.blob());if("blob:"===l.meta.url.protocol&&(d.blob=!0,d.base=d.url=new URL(d.url.pathname)),i.referrer&&i.referrer.startsWith(location.origin)){let e=new URL(l.sourceUrl(i.referrer));(d.headers.origin||l.meta.url.origin!==e.origin&&"cors"===i.mode)&&(d.headers.origin=e.origin),d.headers.referer=e.href}let h=await l.cookie.getCookies(c)||[],u=l.cookie.serialize(h,l.meta,!1);d.headers["user-agent"]=navigator.userAgent,u&&(d.headers.cookie=u);let p=new o(d,null,null);if(this.emit("request",p),p.intercepted)return p.returnValue;a=d.blob?"blob:"+location.origin+d.url.pathname:d.url;let m=await this.bareClient.fetch(a,{headers:d.headers,method:d.method,body:d.body,credentials:d.credentials,mode:d.mode,cache:d.cache,redirect:d.redirect}),f=new s(d,m),g=new o(f,null,null);if(this.emit("beforemod",g),g.intercepted)return g.returnValue;for(let e of t)f.headers[e]&&delete f.headers[e];if(f.headers.location&&(f.headers.location=l.rewriteUrl(f.headers.location)),["document","iframe"].includes(i.destination)){let e=f.getHeader("content-disposition");if(!/\s*?((inline|attachment);\s*?)filename=/i.test(e)){let t=/^\s*?attachment/i.test(e)?"attachment":"inline",[r]=new URL(m.finalURL).pathname.split("/").slice(-1);f.headers["content-disposition"]=`${t}; filename=${JSON.stringify(r)}`}}if(f.headers["set-cookie"]&&(Promise.resolve(l.cookie.setCookies(f.headers["set-cookie"],c,l.meta)).then((()=>{self.clients.matchAll().then((function(e){e.forEach((function(e){e.postMessage({msg:"updateCookies",url:l.meta.url.href})}))}))})),delete f.headers["set-cookie"]),f.body)switch(i.destination){case"script":f.body=l.js.rewrite(await m.text());break;case"worker":{let e=[l.bundleScript,l.clientScript,l.configScript,l.handlerScript].map((e=>JSON.stringify(e))).join(",");f.body=`(async ()=>{${l.createJsInject(l.cookie.serialize(h,l.meta,!0),i.referrer)} importScripts(${e}); await __uv$promise;\n`,f.body+=l.js.rewrite(await m.text()),f.body+="\n})()"}break;case"style":f.body=l.rewriteCSS(await m.text());break;case"iframe":case"document":if(f.getHeader("content-type")&&f.getHeader("content-type").startsWith("text/html")){let e=await m.text();if(Array.isArray(this.config.inject)){let t=e.indexOf("<head>"),r=e.indexOf("<HEAD>"),i=e.indexOf("<body>"),s=e.indexOf("<BODY>"),n=new URL(a),o=this.config.inject;for(let a of o)new RegExp(a.host).test(n.host)&&("head"===a.injectTo?(-1!==t||-1!==r)&&(e=e.slice(0,t)+`${a.html}`+e.slice(t)):"body"===a.injectTo&&(-1!==i||-1!==s)&&(e=e.slice(0,i)+`${a.html}`+e.slice(i)))}f.body=l.rewriteHtml(e,{document:!0,injectHead:l.createHtmlInject(l.handlerScript,l.bundleScript,l.clientScript,l.configScript,l.cookie.serialize(h,l.meta,!0),i.referrer)})}}return"text/event-stream"===d.headers.accept&&(f.headers["content-type"]="text/event-stream"),crossOriginIsolated&&(f.headers["Cross-Origin-Embedder-Policy"]="require-corp"),this.emit("response",g),g.intercepted?g.returnValue:new Response(f.body,{headers:f.headers,status:f.status,statusText:f.statusText})}catch(e){return["document","iframe"].includes(i.destination)?(console.error(e),function(e,t){let r=String(e);if(r.includes("wasm not loaded yet, please call libcurl.load_wasm first")||r.includes("libcurl.load_wasm"))return new Response("<script>location.reload();<\/script>",{status:200,headers:{"content-type":"text/html"}});let i={"content-type":"text/html"};return crossOriginIsolated&&(i["Cross-Origin-Embedder-Policy"]="require-corp"),new Response(function(e,t){let r=`\n        errorTrace.value = ${JSON.stringify(e)};\n        fetchedURL.textContent = ${JSON.stringify(t)};\n        for (const node of document.querySelectorAll("#uvHostname")) node.textContent = ${JSON.stringify(location.hostname)};\n        reload.addEventListener("click", () => location.reload());\n        uvVersion.textContent = ${JSON.stringify("3.2.7")};\n    `;return`<!DOCTYPE html>\n        <html>\n        <head>\n        <meta charset='utf-8' />\n        <title>Error</title>\n        <style>\n        * { background-color: white }\n        </style>\n        </head>\n        <body>\n        <h1 id='errorTitle'>Error processing your request</h1>\n        <hr />\n        <p>Failed to load <b id="fetchedURL"></b></p>\n        <p id="errorMessage">Internal Server Error</p>\n        <textarea id="errorTrace" cols="40" rows="10" readonly></textarea>\n        <p>Try:</p>\n        <ul>\n        <li>Checking your internet connection</li>\n        <li>Verifying you entered the correct address</li>\n        <li>Clearing the site data</li>\n        <li>Contacting <b id="uvHostname"></b>'s administrator</li>\n        <li>Verify the server isn't censored</li>\n        </ul>\n        <p>If you're the administrator of <b id="uvHostname"></b>, try:</p>\n        <ul>\n        <li>Restarting your server</li>\n        <li>Updating Ultraviolet</li>\n        <li>Troubleshooting the error on the <a href="https://github.com/titaniumnetwork-dev/Ultraviolet" target="_blank">GitHub repository</a></li>\n        </ul>\n        <button id="reload">Reload</button>\n        <hr />\n        <p><i>Ultraviolet v<span id="uvVersion"></span></i></p>\n        <script src="${"data:application/javascript,"+encodeURIComponent(r)}"><\/script>\n        </body>\n        </html>\n        `}(r,t),{status:500,headers:i})}(e,a)):new Response(void 0,{status:500})}}static Ultraviolet=e};self.UVServiceWorker=i;var s=class{constructor(e,t){this.request=e,this.raw=t,this.ultraviolet=e.ultraviolet,this.headers={};for(let e in t.rawHeaders)this.headers[e.toLowerCase()]=t.rawHeaders[e];this.status=t.status,this.statusText=t.statusText,this.body=t.body}get url(){return this.request.url}get base(){return this.request.base}set base(e){this.request.base=e}getHeader(e){return Array.isArray(this.headers[e])?this.headers[e][0]:this.headers[e]}},n=class{constructor(e,t,r=null){this.ultraviolet=t,this.request=e,this.headers=Object.fromEntries(e.headers.entries()),this.method=e.method,this.body=r||null,this.cache=e.cache,this.redirect=e.redirect,this.credentials="omit",this.mode="cors"===e.mode?e.mode:"same-origin",this.blob=!1}get url(){return this.ultraviolet.meta.url}set url(e){this.ultraviolet.meta.url=e}get base(){return this.ultraviolet.meta.base}set base(e){this.ultraviolet.meta.base=e}},o=class{#e;#t;constructor(e={},t=null,r=null){this.#e=!1,this.#t=null,this.data=e,this.target=t,this.that=r}get intercepted(){return this.#e}get returnValue(){return this.#t}respondWith(e){this.#t=e,this.#e=!0}}})();